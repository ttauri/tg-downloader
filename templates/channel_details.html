{% extends "base.html" %}

{% block content %}
<h2>{{channel.channel_name}} Details </h2>

<!-- Progress Panel -->
<div id="progress-panel" class="progress-panel hidden">
    <div class="progress-header">
        <span id="progress-title">Operation in progress...</span>
        <div class="progress-controls">
            <span id="progress-status" class="status-badge">running</span>
            <button type="button" id="stop-btn" class="stop-btn" onclick="stopTask()">Stop</button>
        </div>
    </div>
    <div class="progress-bar-container">
        <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
    </div>
    <div id="progress-message" class="progress-message">Starting...</div>
</div>

<!-- Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Videos</div>
        <div class="stat-row">
            <span class="stat-downloaded">{{ video_downloaded }}</span>
            <span class="stat-separator">/</span>
            <span class="stat-total">{{ video_count }}</span>
        </div>
        <div class="stat-size-row">
            <span class="size-downloaded">{{ video_downloaded_size }}</span>
            <span class="stat-separator">/</span>
            <span class="size-total">{{ video_size }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Images</div>
        <div class="stat-row">
            <span class="stat-downloaded">{{ image_downloaded }}</span>
            <span class="stat-separator">/</span>
            <span class="stat-total">{{ image_count }}</span>
        </div>
        <div class="stat-size-row">
            <span class="size-downloaded">{{ image_downloaded_size }}</span>
            <span class="stat-separator">/</span>
            <span class="size-total">{{ image_size }}</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Other</div>
        <div class="stat-row">
            <span class="stat-downloaded">{{ other_downloaded }}</span>
            <span class="stat-separator">/</span>
            <span class="stat-total">{{ other_count }}</span>
        </div>
        <div class="stat-size-row">
            <span class="size-downloaded">{{ other_downloaded_size }}</span>
            <span class="stat-separator">/</span>
            <span class="size-total">{{ other_size }}</span>
        </div>
    </div>
    <div class="stat-card total">
        <div class="stat-label">Total</div>
        <div class="stat-row">
            <span class="stat-downloaded">{{ downloaded_media }}</span>
            <span class="stat-separator">/</span>
            <span class="stat-total">{{ all_media }}</span>
        </div>
        <div class="stat-size-row">
            <span class="size-downloaded">{{ total_downloaded_size }}</span>
            <span class="stat-separator">/</span>
            <span class="size-total">{{ total_size }}</span>
        </div>
    </div>
</div>
<div class="stats-legend">
    <span class="legend-item"><span class="legend-color downloaded"></span> Downloaded</span>
    <span class="legend-item"><span class="legend-color total"></span> Total</span>
</div>

<table class="channel-table">
    <thead>
        <tr>
            <th>Status</th>
            <th>Count</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>Fetched</td>
            <td id="all-media-count">{{ all_media }}</td>
            <td>
                <button type="button" id="fetch-btn" class="action-btn" onclick="startFetch()">
                    <span class="btn-text">Fetch messages data</span>
                    <span class="btn-spinner hidden"></span>
                </button>
            </td>
        </tr>
        <tr>
            <td>Downloaded</td>
            <td id="downloaded-count">{{ downloaded_media }}</td>
            <td>
                <button type="button" id="download-btn" class="action-btn" onclick="startDownload()">
                    <span class="btn-text">Download media</span>
                    <span class="btn-spinner hidden"></span>
                </button>
            </td>
        </tr>
        <tr>
            <td>Pending</td>
            <td id="not-downloaded-count">{{ not_downloaded_media }}</td>
            <td></td>
        </tr>
    </tbody>
</table>

<div class="danger-zone">
    <h3>Danger Zone</h3>
    <p>This will delete all fetched media info from the database for this channel. Downloaded files will not be deleted.</p>
    <button type="button" id="reset-btn" class="danger-btn" onclick="confirmReset()">Reset Channel Data</button>
</div>

<!-- Confirmation Modal -->
<div id="confirm-modal" class="modal hidden">
    <div class="modal-content">
        <h3>Confirm Reset</h3>
        <p>Are you sure you want to delete all media records for this channel?</p>
        <p><strong>{{ all_media }}</strong> records will be deleted.</p>
        <div class="modal-buttons">
            <button type="button" class="action-btn" onclick="closeModal()">Cancel</button>
            <button type="button" class="danger-btn" onclick="resetChannel()">Yes, Reset</button>
        </div>
    </div>
</div>

<script>
const channelId = "{{ channel.channel_id }}";
let eventSource = null;
let currentTaskId = null;
let currentBtnId = null;

function showProgress(title) {
    const panel = document.getElementById('progress-panel');
    document.getElementById('progress-title').textContent = title;
    document.getElementById('progress-status').textContent = 'starting';
    document.getElementById('progress-status').className = 'status-badge running';
    document.getElementById('progress-bar').style.width = '0%';
    document.getElementById('progress-message').textContent = 'Starting...';
    document.getElementById('stop-btn').disabled = false;
    panel.classList.remove('hidden');
}

function updateProgress(data) {
    const pct = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
    document.getElementById('progress-bar').style.width = pct + '%';
    document.getElementById('progress-message').textContent = data.message;
    document.getElementById('progress-status').textContent = data.status;
    document.getElementById('progress-status').className = 'status-badge ' + data.status;
}

function hideProgressDelayed() {
    setTimeout(() => {
        document.getElementById('progress-panel').classList.add('hidden');
        currentTaskId = null;
    }, 3000);
}

function setButtonLoading(btnId, loading) {
    const btn = document.getElementById(btnId);
    const text = btn.querySelector('.btn-text');
    const spinner = btn.querySelector('.btn-spinner');

    if (loading) {
        btn.disabled = true;
        text.classList.add('hidden');
        spinner.classList.remove('hidden');
    } else {
        btn.disabled = false;
        text.classList.remove('hidden');
        spinner.classList.add('hidden');
    }
}

function subscribeToProgress(taskId, btnId, title) {
    currentTaskId = taskId;
    currentBtnId = btnId;
    showProgress(title);

    eventSource = new EventSource('/task_progress/' + taskId);

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        updateProgress(data);

        if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
            eventSource.close();
            setButtonLoading(btnId, false);
            document.getElementById('stop-btn').disabled = true;
            hideProgressDelayed();
            if (data.status === 'completed' || data.status === 'cancelled') {
                setTimeout(() => location.reload(), 2000);
            }
        }
    };

    eventSource.onerror = function() {
        eventSource.close();
        setButtonLoading(btnId, false);
        document.getElementById('stop-btn').disabled = true;
        document.getElementById('progress-status').textContent = 'error';
        document.getElementById('progress-status').className = 'status-badge failed';
        hideProgressDelayed();
    };
}

async function stopTask() {
    if (!currentTaskId) return;

    document.getElementById('stop-btn').disabled = true;
    document.getElementById('progress-message').textContent = 'Stopping...';

    try {
        await fetch('/stop_task/' + currentTaskId, { method: 'POST' });
    } catch (error) {
        console.error('Failed to stop task:', error);
    }
}

async function startFetch() {
    setButtonLoading('fetch-btn', true);

    try {
        const response = await fetch('/fetch_messages/?channel_id=' + channelId, {
            method: 'POST'
        });
        const data = await response.json();

        if (data.task_id) {
            subscribeToProgress(data.task_id, 'fetch-btn', 'Fetching messages...');
        }
    } catch (error) {
        setButtonLoading('fetch-btn', false);
        alert('Failed to start fetch: ' + error);
    }
}

async function startDownload() {
    setButtonLoading('download-btn', true);

    try {
        const response = await fetch('/download_media_from_channel/?channel_id=' + channelId, {
            method: 'POST'
        });
        const data = await response.json();

        if (data.task_id) {
            subscribeToProgress(data.task_id, 'download-btn', 'Downloading media...');
        }
    } catch (error) {
        setButtonLoading('download-btn', false);
        alert('Failed to start download: ' + error);
    }
}

function confirmReset() {
    document.getElementById('confirm-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('confirm-modal').classList.add('hidden');
}

async function resetChannel() {
    closeModal();
    document.getElementById('reset-btn').disabled = true;
    document.getElementById('reset-btn').textContent = 'Resetting...';

    try {
        const response = await fetch('/reset_channel/' + channelId, { method: 'POST' });
        const data = await response.json();

        if (data.status === 'success') {
            alert('Deleted ' + data.deleted + ' records');
            location.reload();
        } else {
            alert('Reset failed');
            document.getElementById('reset-btn').disabled = false;
            document.getElementById('reset-btn').textContent = 'Reset Channel Data';
        }
    } catch (error) {
        alert('Reset failed: ' + error);
        document.getElementById('reset-btn').disabled = false;
        document.getElementById('reset-btn').textContent = 'Reset Channel Data';
    }
}
</script>
{% endblock %}

